<!DOCTYPE html>
<html>

<head>
  <link rel='stylesheet' type='text/css' href='https://api.tomtom.com/maps-sdk-for-web/cdn/6.x/6.4.0/maps/maps.css'>
  <script src="https://api.tomtom.com/maps-sdk-for-web/cdn/6.x/6.4.0/maps/maps-web.min.js"></script>
  <script src="https://api.tomtom.com/maps-sdk-for-web/cdn/6.x/6.4.0/services/services-web.min.js"></script>
</head>


<body>
  <div style='width:100vw; height:100vh' id='map'></div>

  <script>
    var AUSTIN = { lng: -97.743, lat: 30.26 }

    var map = tt.map({
      key: 'your-API-key',
      container: 'map',
      center: AUSTIN,
      zoom: 13
    })

    var cloudSource = {
      type: 'raster',
      tiles: ['https://tile.openweathermap.org/map/clouds_new/{z}/{x}/{y}.png?appid=your-openweathermap-id'],
      tileSize: 256,
      minZoom: 0,
      maxZoom: 12,
      attribution: 'OpenWeatherMap.Org'
    }

    var rainSource = {
      type: 'raster',
      tiles: ['https://tile.openweathermap.org/map/precipitation_new/{z}/{x}/{y}.png?appid=your-openweathermap-id'],
      tileSize: 256,
      minZoom: 0,
      maxZoom: 12,
      attribution: 'OpenWeatherMap.Org'
    }

    var cloudLayer = {
      'id': 'cloud_layer',
      'type': 'raster',
      'source': 'cloud_source',
      'layout': { 'visibility': 'visible' }
    }

    var rainLayer = {
      'id': 'rain_layer',
      'type': 'raster',
      'source': 'rain_source',
      'layout': { 'visibility': 'visible' }
    }

    map.on('load', function () {
      map.addSource('cloud_source', cloudSource)
      map.addLayer(cloudLayer)

      map.addSource('rain_source', rainSource)
      map.addLayer(rainLayer)
    })

    map.on('click', function (event) {
      console.log(event.lngLat)
      weatherForCityAround(event.lngLat)
    })

    function createDOM(city) {
      let div = document.createElement('div')
      div.style.font = 'italic bold 24px arial'
      let temp = document.createTextNode(city.main.temp.toFixed(0) + ' F ')

      div.appendChild(temp)

      let code = city.weather[0].icon
      let image = document.createElement('img')
      image.src = 'http://openweathermap.org/img/wn/' + code + '.png'
      div.appendChild(image)

      let description = document.createTextNode(city.weather[0].description)
      div.appendChild(description)

      return div
    }

    async function weatherForCityAround(lngLat) {
      var url = 'https://api.openweathermap.org/data/2.5/find?units=imperial&lat={lat}&lon={lon}&cnt=50&appid=your-openweathermap-id'
      url = url.replace('{lat}', lngLat.lat)
      url = url.replace('{lon}', lngLat.lng)
      let weatherResponse = await fetch(url)
      let weatherData = await weatherResponse.json()
      console.log(weatherData)
      weatherData.list.forEach(element => {
        var popup = new tt.Popup().setDOMContent(createDOM(element)).setLngLat(element.coord).addTo(map)
      });
    }

  </script>
</body>

</html>
